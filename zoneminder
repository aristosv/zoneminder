echo ===============================================================================
echo this script will install zoneminder v1.30.4
echo ===============================================================================
read -p "press enter to continue"
echo set a root password for mariadb: ; read database_root_pass

echo updating
apt-get update

echo upgrading
apt-get -y upgrade

echo dist upgrade
apt-get -y dist-upgrade

echo installing apache
apt-get install -y apache2

echo installing mariadb
apt-get install -y mariadb-server

echo securing mariadb
echo set mariadb root password
mysql --user="root" --password="" --execute="SET PASSWORD FOR 'root'@'localhost' = PASSWORD('$database_root_pass');"

echo removing anonymous users
mysql --user="root" --password="" --execute="DELETE FROM mysql.user WHERE User='';"

echo disabling remote root logins
mysql --user="root" --password="" --execute="DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');"

echo removing test database
mysql --user="root" --password="" --execute="DELETE FROM mysql.db WHERE Db='test' OR Db='test\_%';"

echo flushing privileges
mysql --user="root" --password="" --execute="FLUSH PRIVILEGES;"

echo installing php
apt-get install -y php

echo installing required modules
apt-get install -y php-mysql apache2-mod-php7.0

echo replacing default my.cnf 
rm /etc/mysql/my.cnf
cp /etc/mysql/mariadb.conf.d/50-server.cnf /etc/mysql/my.cnf
sed -i 's/character-set-server = utf8mb4/character-set-server = latin1/g' /etc/mysql/my.cnf
sed -i 's/collation-server = utf8mb4_general_ci/collation-server = latin1_swedish_ci/g' /etc/mysql/my.cnf

echo restarting mariadb
systemctl restart mariadb

echo adding deb multimedia repository
echo "deb http://www.deb-multimedia.org stretch main non-free" >> /etc/apt/sources.list

echo installing deb-multimedia-keyring
wget http://www.deb-multimedia.org/pool/main/d/deb-multimedia-keyring/deb-multimedia-keyring_2016.8.1_all.deb
dpkg -i deb-multimedia-keyring_2016.8.1_all.deb

echo updating
apt-get update

echo upgrading
apt-get -y upgrade

echo installing zoneminder
apt install -y zoneminder vlc-plugin-base php7.0-gd

echo configuring permissions
chmod 740 /etc/zm/zm.conf
chown root:www-data /etc/zm/zm.conf

echo enabling zoneminder
systemctl enable zoneminder.service

echo adding user www-data to video group
adduser www-data video

echo starting zoneminder
systemctl start zoneminder.service

echo configuring apache
a2enmod cgi
a2enmod rewrite
a2enconf zoneminder

echo configuring timezone
sed -i '/date.timezone =/c\date.timezone = Asia/Nicosia' /etc/php/7.0/apache2/php.ini

echo configuring permissions
chown -R www-data:www-data /usr/share/zoneminder/

echo restarting apache
systemctl restart apache2

echo installation complete
