echo ====================================
echo this will install zoneminder v1.30.4
echo ====================================
read -p "press enter to continue"
echo set a root password for mariadb: ; read database_root_pass

echo updating
apt-get update > /dev/null 2>&1

echo upgrading
apt-get -y upgrade > /dev/null 2>&1

echo dist upgrade
apt-get -y dist-upgrade > /dev/null 2>&1

echo installing apache
apt-get install -y apache2 > /dev/null 2>&1

echo installing mariadb
apt-get install -y mariadb-server > /dev/null 2>&1

echo securing mariadb
echo setting mariadb root password
mysql --user="root" --password="" --execute="SET PASSWORD FOR 'root'@'localhost' = PASSWORD('$database_root_pass');"

echo removing anonymous users
mysql --user="root" --password="" --execute="DELETE FROM mysql.user WHERE User='';"

echo disabling remote root logins
mysql --user="root" --password="" --execute="DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');"

echo removing test database
mysql --user="root" --password="" --execute="DELETE FROM mysql.db WHERE Db='test' OR Db='test\_%';"

echo flushing privileges
mysql --user="root" --password="" --execute="FLUSH PRIVILEGES;"

echo installing php
apt-get install -y php > /dev/null 2>&1

echo installing required modules
apt-get install -y php-mysql apache2-mod-php7.0 > /dev/null 2>&1

echo adding deb multimedia repository
echo "deb http://www.deb-multimedia.org stretch main non-free" >> /etc/apt/sources.list

echo installing deb-multimedia-keyring
wget http://www.deb-multimedia.org/pool/main/d/deb-multimedia-keyring/deb-multimedia-keyring_2016.8.1_all.deb > /dev/null 2>&1
dpkg -i deb-multimedia-keyring_2016.8.1_all.deb  > /dev/null 2>&1

echo updating
apt-get update > /dev/null 2>&1

echo upgrading
apt-get -y upgrade > /dev/null 2>&1

echo installing zoneminder
apt-get install -y zoneminder vlc-plugin-base php7.0-gd > /dev/null 2>&1

echo configuring permissions
chmod 740 /etc/zm/zm.conf
chown root:www-data /etc/zm/zm.conf

echo adding user www-data to video group
adduser www-data video > /dev/null 2>&1

echo configuring apache
a2enmod cgi > /dev/null 2>&1
a2enmod rewrite > /dev/null 2>&1

echo configuring timezone
sed -i "s/;date.timezone =/date.timezone = $(sed 's/\//\\\//' /etc/timezone)/g" /etc/php/7.0/apache2/php.ini

echo configuring permissions
chown -R www-data:www-data /usr/share/zoneminder/

echo restarting apache
systemctl restart apache2

echo installation complete
echo you can access zoneminder on http://<ip_address>/zm/
